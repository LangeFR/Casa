<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar sesión</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="login-container">
      <h2>Iniciar sesión</h2>
      <form action="/login" method="POST" enctype="multipart/form-data">
        <label for="user">Usuario:</label><br />
        <input type="text" id="user" name="user" required /><br /><br />

        <label for="pass">Contraseña:</label><br />
        <input type="password" id="pass" name="pass" required /><br /><br />

        <input type="submit" value="Ingresar" />
      </form>
    </div>
    <div>
      <h1>Reconocimiento Facial con Face++</h1>
      <section>
        <h2>2. Verificar Rostro</h2>
        <img
          id="verifyPreview"
          src=""
          alt="Vista previa"
          style="max-width: 100%; margin-top: 10px; display: none"
        />

        <input type="file" id="verifyImage" />
        <button onclick="verifyFace()">Verificar</button>
        <div id="verifyResult" class="result"></div>
      </section>
    </div>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
    <script>
      // 1. Configura tu Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAdfgGP1OWjXVkUtgpK9P149qkMyaZ7Oak",
        authDomain: "iot-p1-65a68.firebaseapp.com",
        databaseURL: "https://iot-p1-65a68-default-rtdb.firebaseio.com",
        projectId: "iot-p1-65a68",
        storageBucket: "iot-p1-65a68.firebasestorage.app",
        messagingSenderId: "931106622215",
        appId: "1:931106622215:web:48d0891ea076a1886493a2",
        measurementId: "G-V5CYFV4HLW",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
    </script>
    <script>
      document
        .getElementById("verifyImage")
        .addEventListener("change", function () {
          const file = this.files[0];
          const previewImg = document.getElementById("verifyPreview");

          if (!file) {
            previewImg.style.display = "none";
            previewImg.src = "";
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
          };
          reader.readAsDataURL(file);
        });
    </script>
    <script>
      const API_KEY = "J8C5ftGY3oPn8i3FIPTxpo6CC3N5J62Z";
      const API_SECRET = "KSPVEjlZnI2K3ODCZaTsqBKCfJM3CnGe";

      async function getFaceTokensFromFirebase() {
        const snapshot = await db.ref("face_tokens").once("value");
        const data = snapshot.val();
        if (!data) return [];
        return Object.values(data).map((entry) => entry.face_token);
      }

      // Función para detectar un rostro y obtener su face_token
      async function detectFace(file) {
        const formData = new FormData();
        formData.append("api_key", API_KEY);
        formData.append("api_secret", API_SECRET);
        formData.append("image_file", file);

        const res = await fetch(
          "https://api-us.faceplusplus.com/facepp/v3/detect",
          {
            method: "POST",
            body: formData,
          }
        );
        const data = await res.json();
        if (data.faces && data.faces.length > 0) {
          return data.faces[0].face_token;
        } else {
          throw new Error("No se detectó ningún rostro.");
        }
      }

      // Verificar rostro
      // Verificar rostro con tokens dentro de /users
      async function verifyFace() {
        const fileInput = document.getElementById("verifyImage");
        const file = fileInput.files[0];
        const previewImg = document.getElementById("verifyPreview");

        if (!file) return;

        document.getElementById("verifyResult").innerText = "Procesando...";

        try {
          // Obtener todos los usuarios
          const snapshot = await db.ref("users").once("value");
          const users = snapshot.val();

          if (!users) {
            document.getElementById("verifyResult").innerText =
              "No hay usuarios registrados.";
            return;
          }

          const userEntries = Object.entries(users); // [[uid1, data1], [uid2, data2], ...]

          for (const [uid, userData] of userEntries) {
            const token = userData.face_token;
            if (!token) continue;

            const formData = new FormData();
            formData.append("api_key", API_KEY);
            formData.append("api_secret", API_SECRET);
            formData.append("image_file1", file);
            formData.append("face_token2", token);

            const res = await fetch(
              "https://api-us.faceplusplus.com/facepp/v3/compare",
              {
                method: "POST",
                body: formData,
              }
            );

            const data = await res.json();

            if (data.confidence && data.confidence >= 50) {
              document.getElementById(
                "verifyResult"
              ).innerText = `✅ Bienvenido ${userData.user}, tu rol es: ${
                userData.rol
              } (Similitud: ${data.confidence.toFixed(2)}%)`;
              return;
            }
          }

          document.getElementById("verifyResult").innerText =
            "❌ No autenticado. No se encontró similitud suficiente.";
        } catch (err) {
          document.getElementById("verifyResult").innerText =
            "Error: " + err.message;
        }
      }
    </script>
    <script>
      // 2. Captura el evento del formulario
      document.querySelector("form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const userInput = document.getElementById("user").value.trim();
        const passInput = document.getElementById("pass").value.trim();

        try {
          const snapshot = await db.ref("users").once("value");
          const users = snapshot.val();

          let found = false;

          for (let key in users) {
            const userData = users[key];
            if (
              userData.user === userInput &&
              userData.password === passInput
            ) {
              alert(`¡Bienvenido ${userInput}! Tu rol es: ${userData.rol}`);
              found = true;
              break;
            }
          }

          if (!found) {
            alert("Usuario o contraseña incorrectos.");
          }
        } catch (error) {
          console.error("Error al acceder a Firebase:", error);
          alert("Ocurrió un error al verificar los datos.");
        }
      });
    </script>
  </body>
</html>
