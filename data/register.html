<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro</title>
    <link rel="stylesheet" href="style.css" />

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div class="register-container">
      <h2>Registrar usuario</h2>
      <form id="registerForm">
        <label for="user">Usuario:</label><br />
        <input type="text" id="user" name="user" required /><br /><br />

        <label for="pass">Contraseña:</label><br />
        <input type="password" id="pass" name="pass" required /><br /><br />

        <label for="rol">Rol:</label><br />
        <select id="rol" name="rol" required>
          <option value="padre">Padre</option>
          <option value="hijo">Hijo</option></select
        ><br /><br />

        <h2>1. Foto de rostro</h2>
        <input type="file" id="registerImage" accept="image/*" required />
        <br />
        <img id="imagePreview" style="max-width: 150px; margin-top: 10px" />
        <div id="registerResult" class="result" style="margin-top: 10px"></div>
        <br /><br />

        <input type="submit" value="Registrar usuario" />
      </form>
    </div>

    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyAdfgGP1OWjXVkUtgpK9P149qkMyaZ7Oak",
        authDomain: "iot-p1-65a68.firebaseapp.com",
        databaseURL: "https://iot-p1-65a68-default-rtdb.firebaseio.com",
        projectId: "iot-p1-65a68",
        storageBucket: "iot-p1-65a68.firebasestorage.app",
        messagingSenderId: "931106622215",
        appId: "1:931106622215:web:48d0891ea076a1886493a2",
        measurementId: "G-V5CYFV4HLW",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const API_KEY = "J8C5ftGY3oPn8i3FIPTxpo6CC3N5J62Z";
      const API_SECRET = "KSPVEjlZnI2K3ODCZaTsqBKCfJM3CnGe";

      function previewImage(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("imagePreview").src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      document
        .getElementById("registerImage")
        .addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) previewImage(file);
        });

      async function detectFace(file) {
        const formData = new FormData();
        formData.append("api_key", API_KEY);
        formData.append("api_secret", API_SECRET);
        formData.append("image_file", file);

        const response = await fetch(
          "https://api-us.faceplusplus.com/facepp/v3/detect",
          {
            method: "POST",
            body: formData,
          }
        );

        const data = await response.json();
        if (data.faces && data.faces.length > 0) {
          return data.faces[0].face_token;
        } else {
          throw new Error("No se detectó ningún rostro.");
        }
      }

      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const user = document.getElementById("user").value.trim();
          const pass = document.getElementById("pass").value.trim();
          const rol = document.getElementById("rol").value;
          const file = document.getElementById("registerImage").files[0];

          const resultEl = document.getElementById("registerResult");

          if (!file) {
            alert("Debes subir una imagen.");
            return;
          }

          resultEl.innerText = "Detectando rostro...";

          try {
            const faceToken = await detectFace(file);

            const newUserRef = db.ref("users").push();

            await newUserRef.set({
              user: user,
              password: pass,
              rol: rol,
              face_token: faceToken,
            });

            resultEl.innerText = "Rostro y usuario registrados correctamente.";
            alert("Usuario registrado exitosamente.");

            document.getElementById("registerForm").reset();
            document.getElementById("imagePreview").src = "";
          } catch (err) {
            console.error("Error al registrar:", err);
            resultEl.innerText = "Error: " + err.message;
            alert("No se pudo registrar el rostro. Intenta con otra imagen.");
          }
        });
    </script>
  </body>
</html>
