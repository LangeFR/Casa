<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar sesión con imagen</title>
    <style>
      .login-container {
        max-width: 400px;
        margin: auto;
        padding: 20px;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 10px;
      }
      canvas {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <h2>Iniciar sesión</h2>
      <form id="imageForm">
        <label for="image">Subir imagen:</label><br />
        <input type="file" id="image" accept="image/*" required /><br /><br />
        <input type="submit" value="Ingresar" />
      </form>
      <p id="result"></p>
    </div>

    <!-- Imágenes base (como base de datos) -->
    <img id="db1" src="db_images/user1.jpg" hidden />
    <img id="db2" src="db_images/user2.jpg" hidden />
    <img id="db3" src="db_images/user3.jpg" hidden />

    <canvas id="canvas" width="100" height="100"></canvas>

    <script>
      const form = document.getElementById("imageForm");
      const result = document.getElementById("result");
      const dbImages = [
        { id: "db1", name: "Usuario 1" },
        { id: "db2", name: "Usuario 2" },
        { id: "db3", name: "Usuario 3" },
      ];

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        result.textContent = "Comparando imagen...";

        const file = document.getElementById("image").files[0];
        if (!file) return;

        const imgURL = URL.createObjectURL(file);
        const uploadedImg = await loadImage(imgURL);

        // Redimensionamos al mismo tamaño
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(uploadedImg, 0, 0, canvas.width, canvas.height);
        const uploadedData = ctx.getImageData(
          0,
          0,
          canvas.width,
          canvas.height
        ).data;

        for (let db of dbImages) {
          const dbImg = document.getElementById(db.id);
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(dbImg, 0, 0, canvas.width, canvas.height);
          const dbData = ctx.getImageData(
            0,
            0,
            canvas.width,
            canvas.height
          ).data;

          if (compareImages(uploadedData, dbData)) {
            result.textContent = `¡Bienvenido, ${db.name}! Imagen coincidente.`;
            return;
          }
        }

        result.textContent = "No se encontró coincidencia con ningún usuario.";
      });

      function loadImage(src) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.src = src;
        });
      }

      function compareImages(data1, data2, tolerance = 5) {
        if (data1.length !== data2.length) return false;

        for (let i = 0; i < data1.length; i++) {
          if (Math.abs(data1[i] - data2[i]) > tolerance) {
            return false;
          }
        }
        return true;
      }
    </script>
  </body>
</html>
